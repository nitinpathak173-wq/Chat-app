<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PurpleChat</title>
    <!-- Tailwind CSS Play CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind theme configuration for our purple color
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using a class
            theme: {
                extend: {
                    colors: {
                        primary: '#6a0dad',
                    },
                    keyframes: {
                        'fade-in-up': {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        'progress': {
                            '0%': { width: '0%' },
                            '100%': { width: '100%' },
                        }
                    },
                    animation: {
                        'fade-in-up': 'fade-in-up 0.3s ease-out',
                        'fade-in': 'fade-in 0.3s ease-out',
                        'progress': 'progress 5s linear forwards',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Simple scrollbar styling for a cleaner look */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px;}
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans antialiased">

    <!-- =========== Authentication Page (Visible on load) =========== -->
    <div id="auth-page" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <!-- Login Form -->
            <div id="login-view">
                <h2 class="text-3xl font-bold text-center text-gray-800">Welcome Back!</h2>
                <p class="text-center text-gray-500">Login to continue to PurpleChat</p>
                <form id="login-form" class="mt-8 space-y-6">
                    <input type="email" id="login-email" placeholder="Email Address" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                    <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                    <button type="submit" class="w-full py-3 text-white bg-primary rounded-md hover:bg-purple-800 transition-colors font-bold active:scale-95">Login</button>
                </form>
                <p class="mt-6 text-sm text-center">Don't have an account? <a href="#" id="show-signup" class="font-medium text-primary hover:underline">Sign up</a></p>
            </div>
            <!-- Signup Form -->
            <div id="signup-view" class="hidden">
                <h2 class="text-3xl font-bold text-center text-gray-800">Create Account</h2>
                <p class="text-center text-gray-500">Get started with PurpleChat</p>
                <form id="signup-form" class="mt-8 space-y-6">
                    <input type="text" id="signup-username" placeholder="Username (must be unique)" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                    <input type="email" id="signup-email" placeholder="Email Address" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                    <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                    <button type="submit" class="w-full py-3 text-white bg-primary rounded-md hover:bg-purple-800 transition-colors font-bold active:scale-95">Sign Up</button>
                </form>
                <p class="mt-6 text-sm text-center">Already have an account? <a href="#" id="show-login" class="font-medium text-primary hover:underline">Login</a></p>
            </div>
        </div>
    </div>

    <!-- =========== Main App Container (Hidden by default) =========== -->
    <div id="app-container" class="hidden h-screen w-screen flex flex-col bg-gray-100 dark:bg-gray-900">
        <!-- Top Navigation -->
        <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center z-10 flex-shrink-0">
            <h1 class="text-2xl font-bold text-primary">PurpleChat</h1>
            <div id="profile-button-container" class="w-10 h-10 rounded-full cursor-pointer" title="Profile">
                 <img id="header-profile-pic" class="w-10 h-10 rounded-full object-cover" src="https://placehold.co/100x100/6a0dad/white?text=P" alt="Profile">
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto pb-20">
            <!-- CHATS PAGE -->
            <div id="chats-page" class="page p-4 relative h-full">
                <input type="search" id="search-input" placeholder="Search existing chats..." class="w-full mb-4 px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                <div id="chat-list" class="space-y-3">
                    <!-- Chat list items will be injected here by JS -->
                </div>
                <!-- New Chat Floating Action Button -->
                <button id="new-chat-btn" class="absolute bottom-6 right-6 bg-primary text-white w-14 h-14 rounded-full flex items-center justify-center text-3xl shadow-lg hover:bg-purple-800 transition transform hover:scale-110 active:scale-95" title="New Chat">
                    +
                </button>
            </div>
            <!-- STATUS PAGE -->
            <div id="status-page" class="page hidden p-4 animate-fade-in">
                <div id="status-list-container" class="space-y-4">
                    <!-- Status list will be rendered here -->
                </div>
                 <button id="new-status-btn" class="absolute bottom-24 right-6 bg-primary text-white w-14 h-14 rounded-full flex items-center justify-center text-3xl shadow-lg hover:bg-purple-800 transition transform hover:scale-110 active:scale-95" title="New Status">
                    +
                </button>
            </div>
            <!-- PROFILE PAGE -->
            <div id="profile-page" class="page hidden p-4 animate-fade-in">
                <div class="max-w-md mx-auto space-y-4">
                    <!-- Profile Card -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
                        <div id="profile-pic-container" class="relative w-24 h-24 mx-auto mb-4 cursor-pointer group">
                            <img id="profile-pic-display" class="w-24 h-24 rounded-full object-cover ring-4 ring-primary ring-opacity-50" src="https://placehold.co/100x100/6a0dad/white?text=A" alt="Profile Picture">
                            <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="text-white text-xs font-bold">Change</span>
                            </div>
                        </div>
                        <input type="file" id="profile-pic-input" class="hidden" accept="image/*">
                        <h3 id="profile-username" class="text-2xl font-bold text-gray-900 dark:text-white">Username</h3>
                        <p id="profile-email" class="text-gray-500 dark:text-gray-400">email@example.com</p>
                    </div>

                    <!-- Bio Card -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-left">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-gray-800 dark:text-gray-200">Bio</h4>
                            <button id="edit-bio-btn" class="text-sm text-primary font-semibold">Edit</button>
                        </div>
                        <p id="bio-text" class="text-gray-600 dark:text-gray-300 text-sm">This is your bio. Click edit to change it.</p>
                        <textarea id="bio-input" class="hidden w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-sm text-gray-900 dark:text-gray-200" rows="3"></textarea>
                        <button id="save-bio-btn" class="hidden mt-2 w-full py-2 text-sm text-white bg-primary rounded-md hover:bg-purple-800 transition active:scale-95">Save</button>
                    </div>

                    <!-- Settings Card -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-gray-800 dark:text-gray-200">Dark Theme</h4>
                            <button id="theme-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-gray-600">
                                <span id="theme-toggle-slider" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span>
                            </button>
                        </div>
                    </div>
                    
                    <button id="logout-button" class="w-full py-2 text-white bg-red-500 rounded-md hover:bg-red-600 transition active:scale-95">Logout</button>
                </div>
            </div>
            
            <!-- OVERLAY PAGES -->
            <!-- CHAT ROOM PAGE -->
            <div id="chat-room-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-20">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-to-chats-btn" class="text-primary font-bold p-2">&lt; Back</button>
                    <div id="chat-room-header-clickable" class="flex items-center space-x-3 cursor-pointer flex-1">
                        <div class="relative w-10 h-10">
                            <img id="chat-room-pic" class="w-10 h-10 rounded-full object-cover" src="https://placehold.co/100x100/6a0dad/white?text=P" alt="Partner">
                            <div id="chat-room-status-dot" class="w-3 h-3 rounded-full absolute bottom-0 right-0 border-2 border-white"></div>
                        </div>
                        <div>
                            <h2 id="chat-room-username" class="font-bold text-gray-900 dark:text-white">Chat Partner</h2>
                            <p id="chat-room-status-text" class="text-xs text-gray-500">Offline</p>
                        </div>
                    </div>
                </header>
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Messages will be injected here -->
                </div>
                <footer class="p-4 bg-white dark:bg-gray-800 border-t dark:border-gray-700">
                    <form id="message-form" class="flex items-center">
                        <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                        <button type="submit" class="ml-3 p-3 bg-primary text-white rounded-full hover:bg-purple-800 transition active:scale-95">Send</button>
                    </form>
                </footer>
            </div>
            
            <!-- SEARCH USERS PAGE -->
            <div id="search-users-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-20">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-search-btn" class="text-primary font-bold p-2">&lt; Back</button>
                    <input type="search" id="user-search-input" placeholder="Search for users by username..." class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                </header>
                <div id="user-search-results" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- User search results will be injected here -->
                </div>
            </div>

            <!-- PARTNER PROFILE PAGE -->
            <div id="partner-profile-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-30 animate-fade-in">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-partner-profile-btn" class="text-primary font-bold p-2">&lt; Back</button>
                    <h2 class="font-bold text-gray-900 dark:text-white">Profile</h2>
                </header>
                <div class="flex-1 overflow-y-auto p-4">
                     <div class="max-w-md mx-auto space-y-4">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
                            <img id="partner-profile-pic" class="w-24 h-24 rounded-full object-cover ring-4 ring-primary ring-opacity-50 mx-auto mb-4" src="https://placehold.co/100x100/6a0dad/white?text=A" alt="Partner Profile Picture">
                            <h3 id="partner-profile-username" class="text-2xl font-bold text-gray-900 dark:text-white">Username</h3>
                            <p id="partner-profile-email" class="text-gray-500 dark:text-gray-400">email@example.com</p>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-left">
                            <h4 class="font-bold text-gray-800 dark:text-gray-200 mb-2">Bio</h4>
                            <p id="partner-profile-bio" class="text-gray-600 dark:text-gray-300 text-sm">No bio available.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GEMINI CHAT PAGE -->
            <div id="gemini-chat-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-20">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-gemini-btn" class="text-primary font-bold p-2">&lt; Back</button>
                    <div class="flex items-center space-x-3">
                        <img src="https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png" class="w-8 h-8 rounded-full object-contain" alt="Gemini">
                        <div>
                            <h2 class="font-bold text-gray-900 dark:text-white">Gemini</h2>
                            <p class="text-xs text-green-500">Online</p>
                        </div>
                    </div>
                </header>
                <div id="gemini-messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Gemini messages will be injected here -->
                </div>
                <footer class="p-4 bg-white dark:bg-gray-800 border-t dark:border-gray-700">
                    <form id="gemini-message-form" class="flex items-center">
                        <input type="text" id="gemini-message-input" placeholder="Ask Gemini anything..." autocomplete="off" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                        <button type="submit" class="ml-3 p-3 bg-primary text-white rounded-full hover:bg-purple-800 transition active:scale-95">Send</button>
                    </form>
                </footer>
            </div>

            <!-- NEW: CREATE STATUS MODAL -->
            <div id="create-status-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 space-y-4">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">Create Status</h3>
                    <div id="status-type-selector">
                        <textarea id="status-text-input" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-200" rows="4" placeholder="What's on your mind?"></textarea>
                        <button id="post-text-status-btn" class="mt-2 w-full py-2 text-white bg-primary rounded-md hover:bg-purple-800 transition active:scale-95">Post Text</button>
                        <div class="my-4 text-center text-gray-500">OR</div>
                        <label for="status-image-input" class="w-full py-2 text-center block cursor-pointer bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            Upload Image
                        </label>
                        <input type="file" id="status-image-input" class="hidden" accept="image/*">
                    </div>
                    <div class="flex justify-end space-x-2">
                         <button id="cancel-status-btn" class="py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-md hover:bg-gray-200 dark:hover:bg-gray-500 transition">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- NEW: STATUS VIEWER -->
            <div id="status-viewer-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex flex-col z-50 p-4">
                <div id="status-progress-bars" class="flex space-x-1 w-full mb-2"></div>
                <div class="flex items-center space-x-3 mb-4">
                    <img id="status-viewer-pic" class="w-10 h-10 rounded-full object-cover" src="">
                    <div>
                        <p id="status-viewer-username" class="font-bold text-white"></p>
                        <p id="status-viewer-timestamp" class="text-xs text-gray-300"></p>
                    </div>
                </div>
                <div id="status-viewer-content" class="flex-1 flex items-center justify-center">
                    <!-- Status content (image or text) goes here -->
                </div>
                <button id="close-status-viewer-btn" class="absolute top-4 right-4 text-white text-2xl">&times;</button>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-t-md flex justify-around p-1 border-t dark:border-gray-700 z-10">
            <button data-page="chats-page" class="nav-btn flex flex-col items-center justify-center w-full py-2 rounded-lg transition-colors duration-200">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                <span class="text-xs font-semibold">Chats</span>
            </button>
            <button data-page="status-page" class="nav-btn flex flex-col items-center justify-center w-full py-2 rounded-lg transition-colors duration-200">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="text-xs font-semibold">Status</span>
            </button>
            <button data-page="gemini-chat-page" class="nav-btn flex flex-col items-center justify-center w-full py-2 rounded-lg transition-colors duration-200">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                <span class="text-xs font-semibold">Gemini</span>
            </button>
            <button data-page="profile-page" class="nav-btn flex flex-col items-center justify-center w-full py-2 rounded-lg transition-colors duration-200">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span class="text-xs font-semibold">Profile</span>
            </button>
        </nav>
    </div>

    <!-- Firebase and App Logic Script -->
    <script type="module">
        // =================================================================
        // 1. FIREBASE SDK IMPORTS (FROM CDN)
        // =================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, getDoc, setDoc, updateDoc,
            collection, query, where, orderBy, onSnapshot, addDoc,
            serverTimestamp, runTransaction, getDocs, limit, writeBatch, Timestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getDatabase, ref, onValue, set, onDisconnect, serverTimestamp as rtdbServerTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { 
            getStorage, 
            ref as storageRef, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        
        // =================================================================
        // 2. FIREBASE CONFIGURATION
        // =================================================================
        const firebaseConfig = {
  apiKey: "AIzaSyBMZBqPHViEWGA7mT_GN_mePBOnqT1NYz0",
  authDomain: "chat-app-e1891.firebaseapp.com",
  projectId: "chat-app-e1891",
  storageBucket: "chat-app-e1891.firebasestorage.app",
  messagingSenderId: "889518853542",
  appId: "1:889518853542:web:969c0d35177a3fb2fd9367"
};


        // =================================================================
        // 3. INITIALIZE FIREBASE & SERVICES
        // =================================================================
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const storage = getStorage(app);
        
        // =================================================================
        // 4. GLOBAL STATE & DOM REFERENCES
        // =================================================================
        let currentUser = null;
        let currentChatPartner = null;
        let unsubscribeChats = null;
        let unsubscribeMessages = null;
        let unsubscribePartnerStatus = null;
        let unsubscribeTypingStatus = null;
        let unsubscribeStatuses = null;
        let typingTimeout = null;
        let geminiChatHistory = [];
        let statusViewerTimeout = null;
        
        const authPage = document.getElementById('auth-page');
        const appContainer = document.getElementById('app-container');
        const pages = document.querySelectorAll('.page');
        
        // Forms & Toggles
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        
        // Buttons
        const logoutButton = document.getElementById('logout-button');
        const navButtons = document.querySelectorAll('.nav-btn');
        const profileButtonContainer = document.getElementById('profile-button-container');
        const newChatBtn = document.getElementById('new-chat-btn');
        
        // Chat List
        const searchInput = document.getElementById('search-input');
        const chatList = document.getElementById('chat-list');
        
        // Chat Room
        const chatRoomPage = document.getElementById('chat-room-page');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages-container');
        const backToChatsBtn = document.getElementById('back-to-chats-btn');
        const chatRoomHeaderClickable = document.getElementById('chat-room-header-clickable');
        const chatRoomUsername = document.getElementById('chat-room-username');
        const chatRoomPic = document.getElementById('chat-room-pic');
        const chatRoomStatusDot = document.getElementById('chat-room-status-dot');
        const chatRoomStatusText = document.getElementById('chat-room-status-text');

        // User Search
        const searchUsersPage = document.getElementById('search-users-page');
        const backFromSearchBtn = document.getElementById('back-from-search-btn');
        const userSearchInput = document.getElementById('user-search-input');
        const userSearchResults = document.getElementById('user-search-results');

        // Profile Page
        const profilePicContainer = document.getElementById('profile-pic-container');
        const profilePicInput = document.getElementById('profile-pic-input');
        const profilePicDisplay = document.getElementById('profile-pic-display');
        const headerProfilePic = document.getElementById('header-profile-pic');
        const profileUsername = document.getElementById('profile-username');
        const profileEmail = document.getElementById('profile-email');
        const editBioBtn = document.getElementById('edit-bio-btn');
        const saveBioBtn = document.getElementById('save-bio-btn');
        const bioText = document.getElementById('bio-text');
        const bioInput = document.getElementById('bio-input');

        // Partner Profile Page
        const partnerProfilePage = document.getElementById('partner-profile-page');
        const backFromPartnerProfileBtn = document.getElementById('back-from-partner-profile-btn');
        const partnerProfilePic = document.getElementById('partner-profile-pic');
        const partnerProfileUsername = document.getElementById('partner-profile-username');
        const partnerProfileEmail = document.getElementById('partner-profile-email');
        const partnerProfileBio = document.getElementById('partner-profile-bio');

        // Gemini Chat Page
        const geminiChatPage = document.getElementById('gemini-chat-page');
        const backFromGeminiBtn = document.getElementById('back-from-gemini-btn');
        const geminiMessagesContainer = document.getElementById('gemini-messages-container');
        const geminiMessageForm = document.getElementById('gemini-message-form');
        const geminiMessageInput = document.getElementById('gemini-message-input');

        // Status Page
        const statusPage = document.getElementById('status-page');
        const newStatusBtn = document.getElementById('new-status-btn');
        const statusListContainer = document.getElementById('status-list-container');
        const createStatusModal = document.getElementById('create-status-modal');
        const cancelStatusBtn = document.getElementById('cancel-status-btn');
        const statusTextInput = document.getElementById('status-text-input');
        const postTextStatusBtn = document.getElementById('post-text-status-btn');
        const statusImageInput = document.getElementById('status-image-input');
        const statusViewerModal = document.getElementById('status-viewer-modal');
        const closeStatusViewerBtn = document.getElementById('close-status-viewer-btn');
        const statusProgressBars = document.getElementById('status-progress-bars');
        const statusViewerPic = document.getElementById('status-viewer-pic');
        const statusViewerUsername = document.getElementById('status-viewer-username');
        const statusViewerTimestamp = document.getElementById('status-viewer-timestamp');
        const statusViewerContent = document.getElementById('status-viewer-content');

        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleSlider = document.getElementById('theme-toggle-slider');

        // =================================================================
        // 5. HELPER FUNCTIONS
        // =================================================================
        const getInitials = (name = '') => name ? name.charAt(0).toUpperCase() : '?';
        const getPlaceholderUrl = (initials) => `https://placehold.co/100x100/6a0dad/white?text=${initials}`;
        const timeAgo = (timestamp) => {
            if (!timestamp) return '';
            const now = Date.now();
            const seconds = Math.floor((now - timestamp.toMillis()) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        };

        // =================================================================
        // 6. PAGE NAVIGATION LOGIC
        // =================================================================
        function showPage(pageId, isOverlay = false) {
            if (!isOverlay) {
                pages.forEach(page => page.classList.add('hidden'));
            }
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.remove('hidden');
                if(!isOverlay) activePage.classList.add('animate-fade-in');
            }
            if (!isOverlay) updateNavButtons(pageId);
        }

        function hidePage(pageId) {
            const page = document.getElementById(pageId);
            if(page) page.classList.add('hidden');
        }

        function updateNavButtons(activePageId) {
            navButtons.forEach(btn => {
                const isTarget = btn.dataset.page === activePageId;
                btn.classList.toggle('text-primary', isTarget);
                btn.classList.toggle('text-gray-500', !isTarget);
                btn.classList.toggle('dark:text-gray-400', !isTarget);
                btn.classList.toggle('bg-purple-100', isTarget);
                btn.classList.toggle('dark:bg-gray-700', isTarget);
            });
        }
        
        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const pageId = btn.dataset.page;
                // Gemini chat is an overlay, not a main page
                if (pageId === 'gemini-chat-page') {
                    showPage(pageId, true);
                } else {
                    showPage(pageId);
                }
            });
        });
        profileButtonContainer.addEventListener('click', () => showPage('profile-page'));

        // =================================================================
        // 7. AUTHENTICATION & PRESENCE MANAGEMENT
        // =================================================================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                    authPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    showPage('chats-page');
                    setupRealtimeListeners();
                    managePresence(user.uid);
                    // Update profile UI
                    profileUsername.textContent = currentUser.username;
                    profileEmail.textContent = currentUser.email;
                    bioText.textContent = currentUser.bio || 'This is your bio. Click edit to change it.';
                    const initials = getInitials(currentUser.username);
                    const profilePicUrl = currentUser.profilePicUrl || getPlaceholderUrl(initials);
                    headerProfilePic.src = profilePicUrl;
                    profilePicDisplay.src = profilePicUrl;
                } else {
                    console.error("User exists in Auth but not in Firestore. Logging out.");
                    signOut(auth); 
                }
            } else {
                currentUser = null;
                authPage.classList.remove('hidden');
                appContainer.classList.add('hidden');
                cleanupRealtimeListeners();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert("Login Error: " + error.message);
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            if (username.length < 3) return alert("Username must be at least 3 characters.");
            if (password.length < 6) return alert("Password must be at least 6 characters.");

            try {
                const usernameDoc = await getDoc(doc(db, "usernames", username.toLowerCase()));
                if (usernameDoc.exists()) throw new Error("Username is already taken.");

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", user.uid);
                    const usernameRef = doc(db, "usernames", username.toLowerCase());
                    
                    transaction.set(userRef, {
                        uid: user.uid,
                        username: username,
                        username_lowercase: username.toLowerCase(),
                        email: email,
                        profilePicUrl: null,
                        bio: '', // Initialize with empty bio
                        createdAt: serverTimestamp(),
                        status: {
                            state: 'offline',
                            last_changed: serverTimestamp(),
                        }
                    });
                    transaction.set(usernameRef, { uid: user.uid });
                });
            } catch (error) {
                alert("Signup Error: " + error.message);
            }
        });
        
        logoutButton.addEventListener('click', async () => {
            if (currentUser) {
                const userStatusRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userStatusRef, {
                    status: { state: 'offline', last_changed: serverTimestamp() }
                });
            }
            signOut(auth);
        });

        showSignup.addEventListener('click', (e) => { e.preventDefault(); loginForm.parentElement.classList.add('hidden'); signupForm.parentElement.classList.remove('hidden'); });
        showLogin.addEventListener('click', (e) => { e.preventDefault(); signupForm.parentElement.classList.add('hidden'); loginForm.parentElement.classList.remove('hidden'); });

        function managePresence(uid) {
            const userStatusDatabaseRef = ref(rtdb, '/status/' + uid);
            const userStatusFirestoreRef = doc(db, '/users/' + uid);

            const isOfflineForDatabase = { state: 'offline', last_changed: rtdbServerTimestamp() };
            const isOnlineForDatabase = { state: 'online', last_changed: rtdbServerTimestamp() };
            const isOfflineForFirestore = { state: 'offline', last_changed: serverTimestamp() };
            const isOnlineForFirestore = { state: 'online', last_changed: serverTimestamp() };

            const connectedRef = ref(rtdb, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === false) return;
                onDisconnect(userStatusDatabaseRef).set(isOfflineForDatabase).then(() => {
                    set(userStatusDatabaseRef, isOnlineForDatabase);
                    updateDoc(userStatusFirestoreRef, { status: isOnlineForFirestore });
                });
            });
        }

        // =================================================================
        // 8. REALTIME LISTENERS & CHAT LIST
        // =================================================================
        function cleanupRealtimeListeners() {
            if (unsubscribeChats) unsubscribeChats();
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            if (unsubscribeTypingStatus) unsubscribeTypingStatus();
            if (unsubscribeStatuses) unsubscribeStatuses();
        }

        function setupRealtimeListeners() {
            cleanupRealtimeListeners();
            // Chat listener
            const chatsQuery = query(
                collection(db, "chats"),
                where("participants", "array-contains", currentUser.uid),
                orderBy("lastMessageTimestamp", "desc")
            );
            
            unsubscribeChats = onSnapshot(chatsQuery, async (snapshot) => {
                const chatPromises = snapshot.docs.map(async (chatDoc) => {
                    const chatData = chatDoc.data();
                    const partnerId = chatData.participants.find(id => id !== currentUser.uid);
                    if (!partnerId) return null;
                    const userDoc = await getDoc(doc(db, "users", partnerId));
                    return userDoc.exists() ? { id: chatDoc.id, partner: userDoc.data(), ...chatData } : null;
                });
                const chats = (await Promise.all(chatPromises)).filter(Boolean);
                renderChatList(chats);
            });

            // Status listener
            const twentyFourHoursAgo = Timestamp.fromMillis(Date.now() - 24 * 60 * 60 * 1000);
            const statusesQuery = query(
                collection(db, "statuses"),
                where("createdAt", ">=", twentyFourHoursAgo),
                orderBy("createdAt", "desc")
            );
            unsubscribeStatuses = onSnapshot(statusesQuery, async (snapshot) => {
                const statusPromises = snapshot.docs.map(async (statusDoc) => {
                    const statusData = statusDoc.data();
                    const authorDoc = await getDoc(doc(db, "users", statusData.authorUid));
                    const viewersCollection = collection(db, `statuses/${statusDoc.id}/viewers`);
                    const viewersSnapshot = await getDocs(viewersCollection);
                    const viewers = viewersSnapshot.docs.map(d => d.id);
                    return { id: statusDoc.id, author: authorDoc.data(), viewers, ...statusData };
                });
                const statuses = await Promise.all(statusPromises);
                renderStatusList(statuses);
            });
        }

        function renderChatList(chats) {
            if (chats.length === 0) {
                chatList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center mt-8">No chats yet. Click the '+' button to find users and start a conversation.</p>`;
                return;
            }
            chatList.innerHTML = chats.map(chat => {
                const isOnline = chat.partner.status?.state === 'online';
                const initials = getInitials(chat.partner.username);
                const profilePicUrl = chat.partner.profilePicUrl || getPlaceholderUrl(initials);
                return `
                <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition chat-item" data-partner-id="${chat.partner.uid}" data-partner-name="${chat.partner.username}" data-partner-pic="${chat.partner.profilePicUrl || ''}">
                    <div class="relative w-12 h-12 flex-shrink-0 mr-4">
                        <img src="${profilePicUrl}" class="w-12 h-12 rounded-full object-cover" alt="Profile Pic">
                        <div class="w-3.5 h-3.5 rounded-full absolute bottom-0 right-0 border-2 border-white ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <p class="font-bold truncate text-gray-900 dark:text-white">${chat.partner.username}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${chat.lastMessage || 'No messages yet'}</p>
                    </div>
                </div>
            `}).join('');
        }
        
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.chat-item').forEach(item => {
                const partnerName = item.dataset.partnerName.toLowerCase();
                item.style.display = partnerName.includes(searchTerm) ? 'flex' : 'none';
            });
        });

        // =================================================================
        // 9. CHAT ROOM LOGIC & READ RECEIPTS & TYPING INDICATOR
        // =================================================================
        chatList.addEventListener('click', (e) => {
            const chatItem = e.target.closest('.chat-item');
            if (chatItem) {
                openChatRoom({
                    uid: chatItem.dataset.partnerId,
                    username: chatItem.dataset.partnerName,
                    profilePicUrl: chatItem.dataset.partnerPic
                });
            }
        });
        
        async function openChatRoom(partner) {
            currentChatPartner = partner;
            showPage('chat-room-page', true);
            chatRoomUsername.textContent = partner.username;
            const initials = getInitials(partner.username);
            chatRoomPic.src = partner.profilePicUrl || getPlaceholderUrl(initials);
            
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            unsubscribePartnerStatus = onSnapshot(doc(db, "users", partner.uid), (doc) => {
                const partnerData = doc.data();
                currentChatPartner = { ...currentChatPartner, ...partnerData }; // Keep partner data updated
                const isOnline = partnerData.status?.state === 'online';
                chatRoomStatusDot.className = `w-3 h-3 rounded-full absolute bottom-0 right-0 border-2 border-white ${isOnline ? 'bg-green-500' : 'bg-gray-400'}`;
                // This will be updated by the typing listener
                if (!chatRoomStatusText.textContent.includes('typing')) {
                    chatRoomStatusText.textContent = isOnline ? 'Online' : 'Offline';
                }
                chatRoomStatusText.className = `text-xs ${isOnline ? 'text-green-500' : 'text-gray-500'}`;
            });
            
            // Listen for partner's typing status
            const typingRef = ref(rtdb, `/typing/${chatId}/${partner.uid}`);
            if (unsubscribeTypingStatus) unsubscribeTypingStatus();
            unsubscribeTypingStatus = onValue(typingRef, (snapshot) => {
                const isTyping = snapshot.val() === true;
                if (isTyping) {
                    chatRoomStatusText.textContent = 'typing...';
                    chatRoomStatusText.className = 'text-xs text-primary italic';
                } else {
                    const isOnline = currentChatPartner.status?.state === 'online';
                    chatRoomStatusText.textContent = isOnline ? 'Online' : 'Offline';
                    chatRoomStatusText.className = `text-xs ${isOnline ? 'text-green-500' : 'text-gray-500'}`;
                }
            });

            const messagesQuery = query(collection(db, `chats/${chatId}/messages`), orderBy("timestamp", "asc"));
            
            if(unsubscribeMessages) unsubscribeMessages();
            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                renderMessages(snapshot.docs);
                markMessagesAsRead(snapshot.docs);
            });
        }
        
        function renderMessages(messageDocs) {
            messagesContainer.innerHTML = messageDocs.map(doc => {
                const msg = doc.data();
                const isSender = msg.senderId === currentUser.uid;
                const readReceipt = isSender ? `
                    <div class="text-xs ${msg.isRead ? 'text-blue-500' : 'text-gray-400'}">
                        ✓✓
                    </div>
                ` : '';

                return `
                    <div class="flex flex-col animate-fade-in-up ${isSender ? 'items-end' : 'items-start'}">
                        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${isSender ? 'bg-primary text-white rounded-br-none' : 'bg-white dark:bg-gray-700 dark:text-white rounded-bl-none shadow-sm'}">
                            <p>${msg.text}</p>
                        </div>
                        <div class="flex items-center mt-1 pr-2">
                            ${readReceipt}
                        </div>
                    </div>`;
            }).join('');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function markMessagesAsRead(messageDocs) {
            const batch = writeBatch(db);
            let updatesMade = false;
            messageDocs.forEach(doc => {
                const msg = doc.data();
                if (msg.receiverId === currentUser.uid && !msg.isRead) {
                    batch.update(doc.ref, { isRead: true });
                    updatesMade = true;
                }
            });
            if (updatesMade) {
                await batch.commit();
            }
        }

        messageInput.addEventListener('input', () => {
            if (!currentChatPartner) return;
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            const typingRef = ref(rtdb, `/typing/${chatId}/${currentUser.uid}`);
            set(typingRef, true);
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                set(typingRef, false);
            }, 2000); // User is considered "stopped typing" after 2 seconds
        });

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text === '' || !currentChatPartner) return;
            
            messageInput.value = '';
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            // Stop typing indicator
            clearTimeout(typingTimeout);
            const typingRef = ref(rtdb, `/typing/${chatId}/${currentUser.uid}`);
            set(typingRef, false);

            try {
                await runTransaction(db, async (transaction) => {
                    const chatRef = doc(db, "chats", chatId);
                    const messagesRef = collection(db, `chats/${chatId}/messages`);
                    transaction.set(doc(messagesRef), {
                        senderId: currentUser.uid,
                        receiverId: currentChatPartner.uid,
                        text: text,
                        type: "text",
                        isRead: false,
                        timestamp: serverTimestamp()
                    });
                    transaction.set(chatRef, {
                        participants: [currentUser.uid, currentChatPartner.uid],
                        lastMessage: text,
                        lastMessageTimestamp: serverTimestamp(),
                        lastSenderId: currentUser.uid
                    }, { merge: true });
                });
            } catch (error) {
                console.error("Error sending message: ", error);
                alert("Could not send message.");
                messageInput.value = text;
            }
        });

        backToChatsBtn.addEventListener('click', () => {
            hidePage('chat-room-page');
            currentChatPartner = null;
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            if (unsubscribeTypingStatus) unsubscribeTypingStatus();
        });

        // =================================================================
        // 10. USER SEARCH LOGIC
        // =================================================================
        newChatBtn.addEventListener('click', () => {
            showPage('search-users-page', true);
            userSearchInput.value = '';
            userSearchResults.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center mt-4">Type a username to find users.</p>';
        });

        backFromSearchBtn.addEventListener('click', () => hidePage('search-users-page'));

        userSearchInput.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            if (searchTerm.length < 2) {
                userSearchResults.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center mt-4">Keep typing to search...</p>';
                return;
            }

            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, 
                    where("username_lowercase", ">=", searchTerm),
                    where("username_lowercase", "<=", searchTerm + '\uf8ff'),
                    limit(10)
                );
                
                const querySnapshot = await getDocs(q);
                const users = [];
                querySnapshot.forEach((doc) => {
                    if (doc.id !== currentUser.uid) users.push(doc.data());
                });
                renderUserSearchResults(users);
            } catch (error) {
                console.error("Error searching users:", error);
                userSearchResults.innerHTML = '<p class="text-red-500 text-center mt-4">Error searching for users. Ensure database indexes are configured.</p>';
            }
        });

        function renderUserSearchResults(users) {
            if (users.length === 0) {
                userSearchResults.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center mt-4">No users found.</p>';
                return;
            }
            userSearchResults.innerHTML = users.map(user => {
                const isOnline = user.status?.state === 'online';
                const initials = getInitials(user.username);
                const profilePicUrl = user.profilePicUrl || getPlaceholderUrl(initials);
                return `
                <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition user-search-item" data-user-id="${user.uid}" data-user-name="${user.username}" data-user-pic="${user.profilePicUrl || ''}">
                    <div class="relative w-12 h-12 flex-shrink-0 mr-4">
                        <img src="${profilePicUrl}" class="w-12 h-12 rounded-full object-cover" alt="Profile Pic">
                        <div class="w-3.5 h-3.5 rounded-full absolute bottom-0 right-0 border-2 border-white ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <p class="font-bold truncate text-gray-900 dark:text-white">${user.username}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${user.email}</p>
                    </div>
                </div>
            `}).join('');
        }

        userSearchResults.addEventListener('click', (e) => {
            const userItem = e.target.closest('.user-search-item');
            if (userItem) {
                hidePage('search-users-page');
                openChatRoom({
                    uid: userItem.dataset.userId,
                    username: userItem.dataset.userName,
                    profilePicUrl: userItem.dataset.userPic
                });
            }
        });

        // =================================================================
        // 11. PROFILE & BIO LOGIC
        // =================================================================
        profilePicContainer.addEventListener('click', () => profilePicInput.click());

        profilePicInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || !currentUser) return;

            const toast = document.createElement('div');
            toast.textContent = 'Uploading...';
            toast.className = 'fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg z-50';
            document.body.appendChild(toast);

            try {
                const filePath = `profile-pics/${currentUser.uid}/${Date.now()}-${file.name}`;
                const fileRef = storageRef(storage, filePath);
                
                const snapshot = await uploadBytes(fileRef, file);
                const photoURL = await getDownloadURL(snapshot.ref);

                await updateDoc(doc(db, 'users', currentUser.uid), { profilePicUrl: photoURL });
                currentUser.profilePicUrl = photoURL;
                
                headerProfilePic.src = photoURL;
                profilePicDisplay.src = photoURL;
                
                toast.textContent = 'Upload complete!';
                toast.className = 'fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50';
            } catch (error) {
                console.error("Upload failed:", error);
                toast.textContent = 'Upload failed!';
                toast.className = 'fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-50';
            } finally {
                setTimeout(() => toast.remove(), 3000);
                profilePicInput.value = '';
            }
        });

        editBioBtn.addEventListener('click', () => {
            bioText.classList.add('hidden');
            editBioBtn.classList.add('hidden');
            bioInput.classList.remove('hidden');
            saveBioBtn.classList.remove('hidden');
            bioInput.value = currentUser.bio || '';
            bioInput.focus();
        });

        saveBioBtn.addEventListener('click', async () => {
            const newBio = bioInput.value.trim();
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), { bio: newBio });
                currentUser.bio = newBio;
                bioText.textContent = newBio || 'This is your bio. Click edit to change it.';
            } catch (error) {
                console.error("Failed to save bio:", error);
                alert("Could not save bio.");
            } finally {
                bioText.classList.remove('hidden');
                editBioBtn.classList.remove('hidden');
                bioInput.classList.add('hidden');
                saveBioBtn.classList.add('hidden');
            }
        });
        
        chatRoomHeaderClickable.addEventListener('click', () => {
            if (!currentChatPartner) return;
            
            const initials = getInitials(currentChatPartner.username);
            partnerProfilePic.src = currentChatPartner.profilePicUrl || getPlaceholderUrl(initials);
            partnerProfileUsername.textContent = currentChatPartner.username;
            partnerProfileEmail.textContent = currentChatPartner.email;
            partnerProfileBio.textContent = currentChatPartner.bio || 'No bio available.';
            
            showPage('partner-profile-page', true);
        });

        backFromPartnerProfileBtn.addEventListener('click', () => {
            hidePage('partner-profile-page');
        });


        // =================================================================
        // 12. THEME SWITCHER LOGIC
        // =================================================================
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleSlider.classList.add('dark:translate-x-6');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleSlider.classList.remove('dark:translate-x-6');
            }
            localStorage.setItem('theme', theme);
            // Find the currently active page to update nav buttons correctly
            const activeNav = document.querySelector('.nav-btn.text-primary, .nav-btn.bg-purple-100');
            if (activeNav) {
                updateNavButtons(activeNav.dataset.page);
            }
        }

        themeToggle.addEventListener('click', () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            applyTheme(isDarkMode ? 'light' : 'dark');
        });

        // Apply saved theme on initial load
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);

        // =================================================================
        // 13. GEMINI CHAT LOGIC
        // =================================================================
        backFromGeminiBtn.addEventListener('click', () => {
            hidePage('gemini-chat-page');
        });

        geminiMessageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const prompt = geminiMessageInput.value.trim();
            if (!prompt) return;

            geminiMessageInput.value = '';
            renderGeminiMessage(prompt, 'user');
            renderGeminiMessage('...', 'model', true); // Show loading indicator

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Leave empty
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    renderGeminiMessage(text, 'model');
                } else {
                    throw new Error("Invalid response structure from Gemini API.");
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                renderGeminiMessage("Sorry, I couldn't get a response. Please try again.", 'model');
            }
        });

        function renderGeminiMessage(text, role, isLoading = false) {
            const loadingIndicator = geminiMessagesContainer.querySelector('.loading-indicator');
            if (loadingIndicator && !isLoading) {
                loadingIndicator.remove();
            }

            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex flex-col ${role === 'user' ? 'items-end' : 'items-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-2xl shadow-sm ${
                role === 'user' 
                ? 'bg-primary text-white rounded-br-none' 
                : 'bg-white dark:bg-gray-700 dark:text-white rounded-bl-none'
            }`;
            
            if (isLoading) {
                messageWrapper.classList.add('loading-indicator');
                messageBubble.innerHTML = `<div class="flex items-center space-x-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                </div>`;
            } else {
                messageBubble.textContent = text;
            }

            messageWrapper.appendChild(messageBubble);
            geminiMessagesContainer.appendChild(messageWrapper);
            geminiMessagesContainer.scrollTop = geminiMessagesContainer.scrollHeight;
        }
        
        // =================================================================
        // 14. NEW: STATUS FEATURE LOGIC
        // =================================================================
        newStatusBtn.addEventListener('click', () => createStatusModal.classList.remove('hidden'));
        cancelStatusBtn.addEventListener('click', () => createStatusModal.classList.add('hidden'));

        postTextStatusBtn.addEventListener('click', async () => {
            const content = statusTextInput.value.trim();
            if (!content) return;
            await createStatus('text', content);
        });

        statusImageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            await createStatus('image', file);
        });

        async function createStatus(type, content) {
            const toast = document.createElement('div');
            toast.textContent = 'Posting Status...';
            toast.className = 'fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg z-50';
            document.body.appendChild(toast);
            createStatusModal.classList.add('hidden');

            try {
                let statusContent = content;
                if (type === 'image') {
                    const filePath = `status-media/${currentUser.uid}/${Date.now()}-${content.name}`;
                    const fileRef = storageRef(storage, filePath);
                    const snapshot = await uploadBytes(fileRef, content);
                    statusContent = await getDownloadURL(snapshot.ref);
                }

                await addDoc(collection(db, 'statuses'), {
                    authorUid: currentUser.uid,
                    type: type,
                    content: statusContent,
                    createdAt: serverTimestamp()
                });

                toast.textContent = 'Status Posted!';
                toast.className = 'fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50';
            } catch (error) {
                console.error("Failed to post status:", error);
                toast.textContent = 'Failed to post status!';
                toast.className = 'fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-50';
            } finally {
                setTimeout(() => toast.remove(), 3000);
                statusTextInput.value = '';
                statusImageInput.value = '';
            }
        }
        
        function renderStatusList(statuses) {
            const myStatuses = statuses.filter(s => s.authorUid === currentUser.uid);
            const otherStatuses = statuses.filter(s => s.authorUid !== currentUser.uid);

            const groupedStatuses = otherStatuses.reduce((acc, status) => {
                if (!acc[status.authorUid]) {
                    acc[status.authorUid] = [];
                }
                acc[status.authorUid].push(status);
                return acc;
            }, {});

            const myStatusHtml = `
                <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition status-item" data-author-id="${currentUser.uid}">
                    <div class="relative w-12 h-12 flex-shrink-0 mr-4">
                        <img src="${currentUser.profilePicUrl || getPlaceholderUrl(getInitials(currentUser.username))}" class="w-12 h-12 rounded-full object-cover ring-2 ring-primary">
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <p class="font-bold truncate text-gray-900 dark:text-white">My Status</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${myStatuses.length} updates</p>
                    </div>
                </div>
            `;
            
            const othersStatusHtml = Object.values(groupedStatuses).map(userStatuses => {
                const author = userStatuses[0].author;
                const hasUnseen = userStatuses.some(s => !s.viewers.includes(currentUser.uid));
                const ringColor = hasUnseen ? 'ring-primary' : 'ring-gray-400';
                return `
                    <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition status-item" data-author-id="${author.uid}">
                        <div class="relative w-12 h-12 flex-shrink-0 mr-4">
                            <img src="${author.profilePicUrl || getPlaceholderUrl(getInitials(author.username))}" class="w-12 h-12 rounded-full object-cover ring-2 ${ringColor}">
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <p class="font-bold truncate text-gray-900 dark:text-white">${author.username}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${userStatuses.length} updates</p>
                        </div>
                    </div>
                `
            }).join('');

            statusListContainer.innerHTML = myStatusHtml + othersStatusHtml;
        }

        statusListContainer.addEventListener('click', async (e) => {
            const statusItem = e.target.closest('.status-item');
            if (!statusItem) return;

            const authorId = statusItem.dataset.authorId;
            const twentyFourHoursAgo = Timestamp.fromMillis(Date.now() - 24 * 60 * 60 * 1000);
            const q = query(
                collection(db, 'statuses'),
                where('authorUid', '==', authorId),
                where('createdAt', '>=', twentyFourHoursAgo),
                orderBy('createdAt', 'asc')
            );
            const snapshot = await getDocs(q);
            const statuses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (statuses.length > 0) {
                openStatusViewer(statuses);
            }
        });

        let currentStatusIndex = 0;
        let currentStatuses = [];

        function openStatusViewer(statuses) {
            currentStatuses = statuses;
            currentStatusIndex = 0;
            statusViewerModal.classList.remove('hidden');
            displayCurrentStatus();
        }

        function displayCurrentStatus() {
            if (currentStatusIndex >= currentStatuses.length) {
                closeStatusViewer();
                return;
            }

            const status = currentStatuses[currentStatusIndex];
            const author = status.author;
            
            statusViewerPic.src = author.profilePicUrl || getPlaceholderUrl(getInitials(author.username));
            statusViewerUsername.textContent = author.username;
            statusViewerTimestamp.textContent = timeAgo(status.createdAt);

            if (status.type === 'text') {
                statusViewerContent.innerHTML = `<div class="text-white text-2xl font-bold text-center p-4">${status.content}</div>`;
            } else if (status.type === 'image') {
                statusViewerContent.innerHTML = `<img src="${status.content}" class="max-h-full max-w-full object-contain">`;
            }

            // Mark as viewed
            setDoc(doc(db, `statuses/${status.id}/viewers`, currentUser.uid), { viewedAt: serverTimestamp() });

            // Progress bars
            statusProgressBars.innerHTML = currentStatuses.map((_, index) => `
                <div class="flex-1 h-1 bg-white bg-opacity-30 rounded-full">
                    <div class="h-1 bg-white rounded-full ${index < currentStatusIndex ? 'w-full' : (index === currentStatusIndex ? 'animate-progress' : 'w-0')}"></div>
                </div>
            `).join('');

            clearTimeout(statusViewerTimeout);
            statusViewerTimeout = setTimeout(() => {
                currentStatusIndex++;
                displayCurrentStatus();
            }, 5000); // 5 seconds per status
        }

        function closeStatusViewer() {
            clearTimeout(statusViewerTimeout);
            statusViewerModal.classList.add('hidden');
        }

        closeStatusViewerBtn.addEventListener('click', closeStatusViewer);


    </script>
</body>
</html>
